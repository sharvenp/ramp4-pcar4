import{hi as u,i4 as o,i5 as y,i6 as i,i7 as m,h_ as f,i8 as p,gK as v,gL as L,gM as b,gO as I,gQ as _,gR as w,gS as A,gP as x,gT as h,hl as S,h8 as $,hq as E}from"./main-95e6e76d.js";import{_ as T}from"./screen.vue_vue_type_script_setup_true_lang-3a256862.js";import"./preload-helper-388ac9d5.js";class C extends u{_parseConfig(e){const r=e?.headerControls?.slice()??["wizard","layerReorder","groupToggle","visibilityToggle","searchFilter"];if(o(this.$vApp.$pinia).headerControls=r,!e||!e.root.children)return;this.handlePanelWidths(["legend"]);const t=this.getLayerFixtureConfigs();e.root.children.forEach(s=>{s.layerLegendConfigs=t,this.addItem(s)}),this.$iApi.geo.layer.allLayers().forEach(s=>{this.updateLegend(s)}),this.$iApi.geo.layer.allErrorLayers().forEach(s=>{this.updateLegend(s)})}createItem(e,r){let t;e.layerId===void 0?t=new y(this.$iApi,e,r):(e.sublayerIndex!==void 0&&(e.layerId=`${e.layerId}-${e.sublayerIndex}`),t=new i(this.$iApi,e,r));const s=e.children;return s&&s.forEach(l=>{e.layerLegendConfigs!==void 0&&(l.layerLegendConfigs=e.layerLegendConfigs),t.children.push(this.createItem(l,t))}),t}addItem(e,r){const t=e instanceof m?e:this.createItem(e,r);return this._insertItem(t,r),t}async addLayerItem(e,r){const t=new i(this.$iApi,{layerId:e.id,sublayerIndex:e.layerIdx!==-1?e.layerIdx:void 0,name:e.name},r,e);return e.supportsSublayers&&(await e.loadPromise(),e.getLayerTree().children.map(s=>this._treeWalker(e,s)).map(s=>this.addItem(s,t))),t.treeGrown=!0,this._insertItem(t,r),t}get config(){return super.config}getLegend(){return o(this.$vApp.$pinia).children||[]}getLegendConfig(){return{root:{children:this.getLegend().map(e=>e.getConfig())}}}getItem(e){const r=this.getLegend();let t;return r.some(s=>(t=this._searchTree(s,l=>l.uid===e),t!==void 0)),t}getLayerItem(e){let r=typeof e=="string"?e:e.id;const t=this.getLegend();let s;return t.some(l=>(s=this._searchTree(l,n=>n instanceof i&&n.layerId===r),s!==void 0)),s===void 0&&(r=typeof e=="string"?e:e.uid,t.some(l=>(s=this._searchTree(l,n=>n instanceof i&&n.layerUid===r),s!==void 0))),s}getAllExpanded(e){const r=this.getLegend(),t=[],s=e??!0;return r.forEach(l=>{t.push(...this._searchTreeAll(l,n=>n.children.length>0&&n.expanded===s))}),t}getAllVisible(e){const r=this.getLegend(),t=[],s=e??!0;return r.forEach(l=>{t.push(...this._searchTreeAll(l,n=>n.visibility===s))}),t}updateLegend(e){const r=(t,s)=>{const l=this.getLayerItem(t);s?(l&&t instanceof p&&(l.layer=t),l?.error()):l?.load(t instanceof p?t:void 0)};e.loadPromise().then(()=>{let t=this.getLayerItem(e);if(t?.loadCancelled){r(e,!1);return}if(e.layerType===f.MAPIMAGE){const s=l=>{if(l.isLayerRoot&&!l.isLogicalLayer)t=this.getLayerItem(e),r(e,!1),t&&!t.treeGrown&&(l.children.map(n=>this._treeWalker(e,n)).map(n=>this.addItem(n,t)),t.treeGrown=!0),l.children.forEach(n=>s(n));else if(!l.isLayerRoot&&!l.isLogicalLayer){if(t=this.getLayerItem(`${e.id}-${l.layerIdx}`),t){const n=t.getConfig();delete n.layerId,delete n.sublayerIndex,delete n.children;const a={...this._treeWalker(e,l),...n},d=this.createItem(a);this._replaceItem(t,d)}l.children.forEach(n=>s(n))}else l.isLogicalLayer&&r(this._treeWalker(e,l).layer,!1)};s(e.getLayerTree())}else r(e,!1)}).catch(()=>{r(e,!0),e.supportsSublayers&&e.config.sublayers.forEach(t=>{r(`${e.id}-${t.index}`,!0)})})}expandItems(e,r){const t=this.getLegend(),s=r===void 0?t:r.children;r!==void 0&&this._toggleState(r,{expanded:e}),s.forEach(l=>{this._toggleState(l,{expanded:e})})}showItems(e,r){const t=this.getLegend(),s=r===void 0?t:r.children;r!==void 0&&this._toggleState(r,{visibility:e}),s.forEach(l=>{this._toggleState(l,{visibility:e})})}reloadLayerItem(e){const r=this.getLayerItem(e);return r?r instanceof i?(r._loadCancelled=!1,r.reload(),!0):(console.warn("reloading is not supported for non layer items"),!1):!1}removeItem(e){const r=typeof e=="string"?this.getItem(e):e;return r!==void 0?this._deleteItem(r):!1}removeLayerItem(e){const r=this.getLayerItem(e);return r!==void 0?this._deleteItem(r):!1}_searchTree(e,r){if(r(e))return e;{let t;return e.children.some(s=>(t=this._searchTree(s,r),t!==void 0)),t}}_searchTreeAll(e,r){const t=[],s=[e];for(;s.length>0;){const l=s.shift();l&&r(l)&&t.push(l),l&&s.push(...l.children)}return t}_toggleState(e,r){const t=r.visibility,s=r.expanded;t!==void 0&&e.toggleVisibility(t),s!==void 0&&e.children.length>0&&e.toggleExpanded(s),e.children&&e.children.length>0&&e.children.forEach(l=>{this._toggleState(l,r)})}_insertItem(e,r){o(this.$vApp.$pinia).addItem({item:e,parent:r})}_deleteItem(e){return e.children.length>0&&e.children.forEach(r=>{r.parent=e.parent,this._insertItem(r,e.parent)}),e instanceof i&&e.handlers.forEach(r=>this.$iApi.event.off(r)),o(this.$vApp.$pinia).removeItem(e),!0}_replaceItem(e,r){o(this.$vApp.$pinia).replaceItem({oldItem:e,newItem:r})}_treeWalker(e,r,t){const l=(a=>{const d=[e];for(;d.length>0;){const g=d.shift();if(g&&g.uid===a)return g;g&&d.push(...g.sublayers)}})(r.uid),n={};return r.isLayerRoot&&!r.isLogicalLayer?(n.layer=l,n.name=l.name,n.children=r.children.map(a=>this._treeWalker(e,a,t))):!r.isLayerRoot&&!r.isLogicalLayer?(n.name=r.name,n.children=r.children.map(a=>this._treeWalker(e,a,t))):r.isLogicalLayer&&(n.layer=l,n.name=l.name,n.layerId=l.id,n.sublayerIndex=e.layerIdx===-1?void 0:e.layerIdx),{...n,...t}}}const R=h("svg",{class:"fill-current w-32 h-20",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[h("path",{d:"M0 0h24v24H0z",fill:"none"}),h("path",{d:"M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"})],-1),M=v({__name:"nav-button",setup(c){const{t:e}=L(),r=b("iApi"),t=()=>{r.panel.toggle("legend")};return(s,l)=>{const n=I("mapnav-button");return _(),w(n,{onClickFunction:t,tooltip:x(e)("legend.title")},{default:A(()=>[R]),_:1},8,["tooltip"])}}}),G={en:{"legend.title":"Legend","legend.header.addlayer":"Add Layer","legend.header.reorderlayers":"Reorder Layers","legend.header.groups":"Toggle Groups","legend.header.groups.expand":"Expand All","legend.header.groups.collapse":"Collapse All","legend.header.visible":"Toggle Visibility","legend.header.visible.show":"Show All","legend.header.visible.hide":"Hide All","legend.header.search":"Search layers","legend.header.search.showAncestors":"Include ancestor items","legend.header.search.showChildren":"Include child items","legend.header.search.showLayers":"Search only layers","legend.group.expand":"Expand Group","legend.group.collapse":"Collapse Group","legend.visibility.showLayer":"Show layer","legend.visibility.hideLayer":"Hide layer","legend.visibility.showSymbol":"Show symbol","legend.visibility.hideSymbol":"Hide symbol","legend.visibility.showGroup":"Show group","legend.visibility.hideGroup":"Hide group","legend.symbology.expand":"Expand legend","legend.symbology.hide":"Hide legend","legend.symbology.loading":"Loading...","legend.layer.data":"Show more data","legend.layer.offscale":"Layer out of scale","legend.layer.zoomToVisible":"Zoom to visible scale","legend.layer.options":"More options","legend.layer.controls.metadata":"Metadata","legend.layer.controls.settings":"Settings","legend.layer.controls.datatable":"Datatable","legend.layer.controls.symbology":"Legend","legend.layer.controls.boundaryzoom":"Zoom to Layer Boundary","legend.layer.controls.cancel":"Cancel","legend.layer.controls.remove":"Remove","legend.layer.controls.reload":"Reload","legend.alert.symbologyExpanded":"Layer legend expanded","legend.alert.symbologyCollapsed":"Layer legend collapsed","legend.alert.groupExpanded":"Legend group expanded","legend.alert.groupCollapsed":"Legend group collapsed","legend.alert.layerAdded":"{name} layer added to legend","legend.alert.layerRemoved":"{name} layer removed from legend"},fr:{"legend.title":"Légende","legend.header.addlayer":"Ajouter une couche","legend.header.reorderlayers":"Réorganiser les couches","legend.header.groups":"Basculer les Groupes","legend.header.groups.expand":"Élargir les groupes","legend.header.groups.collapse":"Réduire les groupes","legend.header.visible":"Basculer la Visibilité","legend.header.visible.show":"Montrer tout","legend.header.visible.hide":"Cacher tout","legend.header.search":"[fr] Couches de recherche","legend.header.search.showAncestors":"[fr] Inclure les éléments des ancêtres","legend.header.search.showChildren":"[fr] Inclure les éléments de l'enfant","legend.header.search.showLayers":"[fr] recherche uniquement dans les couches","legend.group.expand":"Développer un groupe","legend.group.collapse":"Réduire un groupe","legend.visibility.showLayer":"Afficher la couche","legend.visibility.hideLayer":"Masquer la couche","legend.visibility.showSymbol":"Afficher le symbole","legend.visibility.hideSymbol":"Masquer le symbole","legend.visibility.showGroup":"Afficher le groupe","legend.visibility.hideGroup":"Masquer le groupe","legend.symbology.expand":"Développer la légende","legend.symbology.hide":"Masquer la légende","legend.symbology.loading":"Chargement en cours...","legend.layer.data":"Afficher plus de données","legend.layer.offscale":"Couche hors de portée","legend.layer.zoomToVisible":"[fr] Zoomer à l'échelle visible","legend.layer.options":"Plus d'options","legend.layer.controls.metadata":"Métadonnées","legend.layer.controls.settings":"Paramètres","legend.layer.controls.datatable":"Tableau de données","legend.layer.controls.symbology":"Légende","legend.layer.controls.boundaryzoom":"Zoomer à la limite","legend.layer.controls.cancel":"Annuler","legend.layer.controls.remove":"Retirer","legend.layer.controls.reload":"Recharger","legend.alert.symbologyExpanded":"Légende de la couche développée","legend.alert.symbologyCollapsed":"Légende de la couche réduite","legend.alert.groupExpanded":"Groupe de légende développé","legend.alert.groupCollapsed":"Groupe de légende réduit","legend.alert.layerAdded":"{name} couche ajoutée à la légende","legend.alert.layerRemoved":"Couche {name} retiré de la légende"}};class B extends C{added(){this.$iApi.component("legend-nav-button",M),this.$iApi.panel.register({legend:{screens:{"legend-screen":S(T)},style:{width:"350px"},alertName:"legend.title",button:{tooltip:"legend.title",icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none" /><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z" /></svg>'}}},{i18n:{messages:G}}),this._parseConfig(this.config!==void 0?JSON.parse(JSON.stringify(this.config)):void 0);const e=this.$vApp.$watch(()=>this.config,r=>this._parseConfig(r!==void 0?JSON.parse(JSON.stringify(r)):void 0));this.removed=()=>{e(),this.$iApi.fixture.get("appbar")&&$(this.$vApp.$pinia).removeButton("legend"),this.$iApi.fixture.get("mapnav")&&E(this.$vApp.$pinia).removeItem("legend"),o().$reset(),this.$iApi.panel.remove("legend")}}}export{B as default};
